"""
Coast phase lookup table for apogee prediction.
Auto-generated by generate_coast_table.py
"""
import numpy as np

# Velocity range (m/s)
VEL_RANGE = np.array([0.0, 5.333333333333333, 10.666666666666666, 16.0, 21.333333333333332, 26.666666666666664, 32.0, 37.33333333333333, 42.666666666666664, 48.0, 53.33333333333333, 58.666666666666664, 64.0, 69.33333333333333, 74.66666666666666, 80.0])

# Cd range
CD_RANGE = np.array([0.44, 0.6773333333333333, 0.9146666666666667, 1.152, 1.3893333333333333, 1.6266666666666667, 1.8639999999999999, 2.1013333333333333, 2.3386666666666667, 2.576, 2.8133333333333335, 3.050666666666667, 3.288, 3.525333333333333, 3.7626666666666666, 4.0])

# Altitude gain table [n_vel, n_cd] (meters)
ALTITUDE_TABLE = np.array([
    [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
    [1.444372868717456, 1.4426534331007586, 1.4409282750821337, 1.4392189852411266, 1.43750528070591, 1.4358059868436925, 1.4341036345132936, 1.4324048384529995, 1.4307230884741489, 1.4290355067568774, 1.4273633975543545, 1.4256869319364374, 1.4240243196674984, 1.4223588731313168, 1.4206968582189814, 1.4190510923614954],
    [5.744795888252607, 5.717825798876837, 5.691181641910818, 5.664863519400415, 5.638865057346935, 5.613191985192643, 5.587816281679825, 5.562741646452333, 5.537962273841474, 5.513472488100598, 5.489266739553759, 5.465339600885216, 5.441685763564513, 5.418300034400716, 5.395177332220667, 5.37231268466553],
    [12.79039068682159, 12.658747247663761, 12.53063662239007, 12.405900517406604, 12.284385613895761, 12.165960808950288, 12.050496651431443, 11.937862338400027, 11.827961194167482, 11.720666144548582, 11.615883220967508, 11.5135154661168, 11.413462301986105, 11.315655948656891, 11.219994452369761, 11.126408963986009],
    [22.406753874177543, 22.010784202242334, 21.632774664062868, 21.27139652581618, 20.92545608938063, 20.59387683448604, 20.2756963080128, 19.97002264189305, 19.676055189549324, 19.393061102314817, 19.120383448370358, 18.85740911304336, 18.603556967891745, 18.358340594260724, 18.121261260280807, 17.891881195060307],
    [34.36955364432567, 33.46010024691862, 32.61132595421573, 31.816740771530114, 31.070787639870055, 30.368681955535376, 29.70628017908931, 29.07997206810309, 28.486602397621976, 27.923377725314012, 27.38784104720654, 26.877794462188593, 26.391303652090716, 25.92660003482477, 25.482131916845635, 25.056463736650947],
    [48.42050503972633, 46.66428157675688, 45.065589244573445, 43.60212293962595, 42.25579214560413, 41.01175916504204, 39.857713631822946, 38.78331736194618, 37.77986262583101, 36.839897480132876, 35.95704560228394, 35.125780232249866, 34.34132360284385, 33.599472411534066, 32.89654349708254, 32.22929434967741],
    [64.28346633249282, 61.279451553078474, 58.6156118266908, 56.23213583436427, 54.083084270560086, 52.132484626599435, 50.35167061522571, 48.71748881573523, 47.21101158648291, 45.81656365836429, 44.52105595833847, 43.31342829281727, 42.18431314758674, 41.125654804100776, 40.130530201849325, 39.19291390960136],
    [81.67894183135549, 76.9808920397908, 72.92432716244781, 69.3754489389157, 66.23677310516217, 63.43527874767734, 60.91500469419367, 58.63223888277762, 56.55223548356901, 54.647004602554745, 52.893673599177816, 51.27336496494135, 49.77032111765868, 48.37128697967155, 47.06499786060835, 45.84184433834864],
    [100.33591741744648, 93.476312182996, 87.7076147127696, 82.76890698886874, 78.47942831110296, 74.70931216260858, 71.3624826812948, 68.3660920119754, 65.66371357545532, 63.21089356979408, 60.972043929668, 58.918284362651846, 57.02591926849379, 55.2752627942922, 53.649835654500755, 52.13573095550249],
    [120.00056224317277, 110.51244284312425, 102.73552321275649, 96.21233178064703, 90.6406791873302, 85.81169166988082, 81.57560058597034, 77.82180504739081, 74.46656770524552, 71.44517632976353, 68.70671139248975, 66.2104602549488, 63.92344786398733, 61.81864793671462, 59.87362688374744, 58.06965847818232],
    [140.4417907921614, 127.87655174732284, 117.82806908177437, 109.55896173847235, 102.60346354174688, 96.65059085742814, 91.48359138804682, 86.94608762320387, 82.92197668038567, 79.32302048098926, 76.08079980996804, 73.14129908091562, 70.46125699523651, 68.00556863156407, 65.74537212777422, 63.656745259037606],
    [161.45420644790133, 145.39460156297275, 132.848438224618, 122.7050131224394, 114.29099396271786, 107.17083444053664, 101.04845645419122, 95.71456393810037, 91.01641287523758, 86.83958375599836, 83.09642408609294, 79.71854319657776, 76.65162546601519, 73.85199377616327, 71.28403712256835, 68.91837780651538],
    [182.85891407089318, 162.92739719512824, 147.69558900752372, 135.57988697075254, 125.65602510712301, 117.34284981458177, 110.25402090039186, 104.1212754006199, 98.75176422130453, 94.0028012812365, 89.7662446325435, 85.95848575097943, 82.5136971259884, 79.37929451881635, 76.51268693932712, 73.87897091631682],
    [204.50279509456826, 180.3659347492268, 162.29701500130597, 148.13802266683996, 136.67236049794926, 127.15442298473238, 119.0982249620311, 112.17163270088629, 106.13895561644033, 100.82766905925709, 96.1082761012459, 91.88140636529437, 88.06942408540742, 84.6106428766874, 81.45539408456828, 78.56317386748358],
    [226.25682909285308, 197.6266167606334, 176.6026090518368, 160.35223720491095, 147.328485628913, 136.6048159833442, 127.58786741167253, 119.87772030463395, 113.1937748942641, 107.33264992474108, 102.14283977642212, 97.5089395112636, 93.3412905473892, 89.56906655470333, 86.13551868752182, 82.9945272564447],
])

def get_remaining_altitude(velocity, cd):
    """
    Get remaining altitude to apogee using bilinear interpolation.
    
    Args:
        velocity: Current velocity (m/s)
        cd: Current drag coefficient
    
    Returns:
        Estimated remaining altitude (m)
    """
    # Clamp inputs to table bounds
    vel = np.clip(velocity, VEL_RANGE[0], VEL_RANGE[-1])
    cd_val = np.clip(cd, CD_RANGE[0], CD_RANGE[-1])
    
    # Find indices for bilinear interpolation
    vel_idx = np.searchsorted(VEL_RANGE, vel) - 1
    vel_idx = np.clip(vel_idx, 0, len(VEL_RANGE) - 2)
    
    cd_idx = np.searchsorted(CD_RANGE, cd_val) - 1
    cd_idx = np.clip(cd_idx, 0, len(CD_RANGE) - 2)
    
    # Get corner values
    v0, v1 = VEL_RANGE[vel_idx], VEL_RANGE[vel_idx + 1]
    c0, c1 = CD_RANGE[cd_idx], CD_RANGE[cd_idx + 1]
    
    # Bilinear interpolation weights
    vel_weight = (vel - v0) / (v1 - v0) if v1 != v0 else 0.0
    cd_weight = (cd_val - c0) / (c1 - c0) if c1 != c0 else 0.0
    
    # Get corner altitudes
    alt_00 = ALTITUDE_TABLE[vel_idx, cd_idx]
    alt_01 = ALTITUDE_TABLE[vel_idx, cd_idx + 1]
    alt_10 = ALTITUDE_TABLE[vel_idx + 1, cd_idx]
    alt_11 = ALTITUDE_TABLE[vel_idx + 1, cd_idx + 1]
    
    # Bilinear interpolation
    alt_0 = alt_00 * (1 - vel_weight) + alt_10 * vel_weight
    alt_1 = alt_01 * (1 - vel_weight) + alt_11 * vel_weight
    alt = alt_0 * (1 - cd_weight) + alt_1 * cd_weight
    
    return alt
